# TIL Template

## 날짜: 2025-04-23

### 스크럼
- 학습 목표 1 : 파이널 프로젝트 - Rest API 설계
- 학습 목표 2 : 파이널 프로젝트 - ERD 피드백 반영

### 과제 진행사항  
#### 1) 통계 테이블 구성 및 인덱싱 전략  
**a. 타입별 통계 테이블 구성 + 미리 계산**
  - 장점
      - 리포트 타입(연간/주간 등)에 맞는 데이터가 미리 계산되어 저장되어 있으므로, 단순히 조회하여 반환할 수 있음
      - 관심사 분리의 장점
          - 구성방식이 다른 리포트를 더욱 명확하게 설계가능 → 유지보수성 증가
          - 책임분리
      - 각 테이블 별로 성능 최적화 전략을 다르게 가져갈 수 있음
  - 단점
      - 섭취기록 수정 시, 리포트 종류별 테이블이 모두 업데이트 되어야함
      - 리포트 유형을 추가할 때 어려움 존재. 부가적인 테이블의 설계 및 테이블 범위에 맞는 데이터를 가져와야 함
      - 중복되는 필드와 로직이 테이블 간 반복

**b. 통계-섭취기록 간의 매핑 테이블 + 실시간 계산**  
  - 장점
    - 연결된 섭취기록으로부터 통계를 실시간 계산 가능
      → 섭취기록 수정 시에도, 별다른 업데이트 없음
    - 통계 범위를 유연하게 조합하여, 새로운 유형의 리포트를 추가할 수 있음
        - ex) 분기별 리포트
  - 단점
    - 리포트를 조회할 때마다, 리포트 타입(연간/주간 등)에 맞는 데이터 계산 로직이 수행됨 → 조회 성능 저하
    - 리포트 타입별 조건 분기로 인해 쿼리 복잡성이 증가할 수 있다
    - 유형별로 다른 성능 최적화 전략을 가져갈 수 없음
    - 테이블의 컬럼 중 NULL을 허용하는 컬럼이 많아질 수 있음

**→ 조회 성능과 단순성, 관심사 분리의 장점을 기반으로,
타입별 통계 테이블 구성 + 미리 계산 방식을 채택하였습니다**

<br>

**그에 따른 통계 테이블 인덱싱 전략**

- **월간 통계,** **주간 통계, 일일 통계**에 인덱싱 적용

  월간 통계

    ```java
    // 유저 아이디 기반 조회
    CREATE INDEX idx_user_year_month 
    ON monthly_statistics (user_id, year, month); 
    
    // 상위 테이블 (연간) 기반 조회
    CREATE INDEX idx_monthly_annual
    ON monthly_statistics (annual_statistics_id);
    ```

  주간 통계

    ```java
    // 유저 아이디 기반 조회
    CREATE INDEX idx_user_year_month_week
    ON weekly_statistics (user_id, year, month, week_num);
    
    // 상위 테이블 (월간) 기반 조회
    CREATE INDEX idx_weekly_monthly
    ON weekly_statistics (monthly_statistics_id);
    ```

  일일 통계

    ```java
    CREATE INDEX idx_daily_weekly
    ON daily_statistics (weekly_statistics_id);
    ```

    - 일일 통계는 단건 조회나 날짜 필터를 사용하지 않고, 항상 특정 주간 통계에 연관된 리스트를 조회하는 방식으로만 사용하므로, user_id 기반 인덱싱은 불필요

- 연간 통계에는 인덱싱 적용하지 않음
    - 연간 통계 테이블은 다른 통계 테이블에 비해 데이터가 매우 적음
      (월간 통계는 연간 통계의 12배)

  → 운영 중 `slow query log` 등의 도구를 통해 쿼리 성능 저하가 확인되면, 추후 확장 고려

### 오늘의 회고
 - 드디어 이알디 설계 통과를 받았다.. 행복하다..
 - erd 설계 근거를 작성하며, 복합키, 인덱싱 전략 등 설계 상에서 고려할 사항이 매우 많음을 알게되었다.
